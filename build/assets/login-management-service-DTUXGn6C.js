var g=(h,e,t)=>new Promise((i,s)=>{var o=r=>{try{a(t.next(r))}catch(u){s(u)}},n=r=>{try{a(t.throw(r))}catch(u){s(u)}},a=r=>r.done?i(r.value):Promise.resolve(r.value).then(o,n);a((t=t.apply(h,e)).next())});import{s as l,S as c,P as m,T as I,C as p}from"./temp-storage.service-BD8v5Cjg.js";import{N as d}from"./notifications.constant-CpYlRevd.js";import{p as b}from"./sha256-C6hLnjrm.js";import{g as A,f as E,b as f}from"./imaios-global-D0pGfse-.js";class S{constructor(){this.isInitialized=!1,this.subscriber=new b.Subscriber("login-management-subscriber"),this.onConnectionCheckFinished=()=>g(this,null,function*(){}),this.awaitableConnection=new Promise(e=>this.onConnectionCheckFinished=e),window.addEventListener("DOMContentLoaded",e=>{this.subscribeToEvents()}),window.addEventListener("pageshow",e=>{e.persisted&&(imaios.store("are-credentials-reliable",!1),this.loadLogin()),(e.persisted||typeof window.performance!="undefined"&&window.performance.getEntriesByType("navigation").some(t=>t.type==="back_forward"))&&A("guard:user-connected")&&(this.isConnected()||window.location.reload()),this.subscribeToEvents()}),window.addEventListener("pagehide",()=>{imaios.store("are-credentials-reliable",!1),this.unsubscribe()}),this.subscribeToEvents()}isConnected(){return this.getEmailFromStorage()!==null}getUserInformation(){return new Promise((e,t)=>{const i="vw="+document.documentElement.clientWidth+"&vh="+document.documentElement.clientHeight+"&dw="+window.screen.width+"&dh="+window.screen.height;E(`/${imaios.getSiteAccess()}/api/user/information?${i}`).then(s=>s.json()).then(s=>e(s)).catch(()=>t()).finally(()=>this.onConnectionCheckFinished())})}loadLogin(){this.checkExpire(),l.get(c.IMAIOS_USER_INFORMATION)===null?this.getUserInformation().then(e=>{typeof e=="object"&&Object.keys(e).length>0?(this.addLoginToStorage(e),this.replaceUserInformation()):this.displayLoggedOutInformation(),this.hidePlaceholderAndDisplayUserInformation(),window.imaios.pubsub.publish(d.USER_INFORMATIONS_AVAILABLE,l.get(c.IMAIOS_USER_INFORMATION)),imaios.store("are-credentials-reliable",!0)}).catch(()=>{this.hidePlaceholderAndDisplayUserInformation(),this.displayLoggedOutInformation(),imaios.store("are-credentials-reliable",!1)}):(this.hidePlaceholderAndDisplayUserInformation(),this.replaceUserInformation(),window.imaios.pubsub.publish(d.USER_INFORMATIONS_AVAILABLE,l.get(c.IMAIOS_USER_INFORMATION)),imaios.store("are-credentials-reliable",!0))}replaceUserInformation(){var s;this.updateAccessViaThirdPartyCookie();const e=this.getEmailFromStorage(),t=this.getNameFromStorage();if(e!==null){const o=this.getIsLoginAsFromStorage();this.replaceUserEmail(e,o)}else this.displayLoggedOutInformation();t!==null&&this.replaceUserName(t);let i=f(p.THIRD_PARTY_PROVIDER);if(i)try{i=JSON.parse(decodeURIComponent(i)),i!==null&&typeof i.provider!="undefined"&&this.replaceInstituteIfExist(i.provider,!0)}catch(o){}else{const o=this.getLocalUserData(),n=this.getInstituteFromStorage();n!==null&&this.replaceInstituteIfExist(n,(s=o.isIp)!=null?s:!1)}}replaceUserName(e){const t=document.getElementById("user-name-account"),i=document.getElementById("user-name-account-avatar");e.firstName.length>0&&e.lastName.length>0&&(t.innerText=e.firstName+" "+e.lastName,i.innerHTML=`<p class="mb-0 text-xl text-center">${e.firstName[0]+e.lastName[0]}</p>`)}replaceUserEmail(e,t){if(this.toggleDisplayLoginElements(),e!==null){const i=document.querySelectorAll(".imaios-login-logged-out");for(let n=0;n<i.length;n++)i[n].classList.add("d-none");const s=document.querySelectorAll(".imaios-login-logged-in");for(let n=0;n<s.length;n++)s[n].classList.remove("d-none");const o=document.querySelectorAll(".imaios-login");if(o.length>0){const n=t?"LOGGED IN AS ":"";for(let a=0;a<o.length;a++)if(o[a].classList.contains("imaios-login-mobile")){const r=e.split("");let u=r.slice(0,r.indexOf("@"));o[a].innerText=n+u.join("")}else o[a].innerText=n+e}}}toggleDisplayLoginElements(){const e=document.querySelectorAll(".imaios-login-logged-in");for(let t=0;t<e.length;t++)e[t].style.setProperty("display","")}getLocalUserData(){var e;return(e=l.get(c.IMAIOS_USER_INFORMATION))!=null?e:null}getEmailFromStorage(){const e=this.getLocalUserData();return e!==null?e.email:null}getNameFromStorage(){const e=this.getLocalUserData();return e!==null&&e.firstName!==null&&e.lastName!==null?{firstName:e.firstName,lastName:e.lastName}:null}getIsLoginAsFromStorage(){const e=this.getLocalUserData();return e!==null?!!e.is_login_as:!1}getInstituteFromStorage(){const e=this.getLocalUserData();return e!==null?e.b2b_customer_name:null}addLoginToStorage(e){l.add(c.IMAIOS_USER_INFORMATION,e),this.onConnectionCheckFinished()}unsubscribe(){this.subscriber.unsubscribeFromPublisherId(imaios.pubsub.getId()),this.isInitialized=!1}subscribeToEvents(){if(!this.isInitialized){this.isInitialized=!0,this.subscriber.subscribe(imaios.pubsub,d.LOGOUT,()=>{l.remove(c.IMAIOS_USER_INFORMATION),imaios.store("is-connected",!1)}),this.subscriber.subscribe(imaios.pubsub,d.IS_REQUIRING_REFRESH_USER_INFO,()=>{l.remove(c.IMAIOS_USER_INFORMATION),this.loadLogin()});const e=document.querySelectorAll(".imaios-login-logged-out a");for(let t=0;t<e.length;t++)e[t].addEventListener("click",i=>{imaios.pubsub.publish(d.LOGOUT)});imaios.pubsub.publish(d.LOGIN_MANAGER_READY,this)}}checkExpire(){l.checkExpire(c.IMAIOS_USER_INFORMATION)}replaceInstituteIfExist(e,t=!1){if(e!==null&&t){const i=document.querySelectorAll(".imaios-institute");for(let s=0;s<i.length;s++){i[s].style.setProperty("display","");const o=i[s].querySelector(".imaios-institute-text");o!==null&&(o.innerText=e)}}}haveAccessToProduct(e){const t=this.getLocalUserData();return t!==null?typeof t.access[e]!="undefined":!1}deleteSubscriptionsTags(){this.haveAccessToProduct(m.E_ANATOMY)&&this.deleteSubscriptionsTagsByApplication(m.E_ANATOMY),this.haveAccessToProduct(m.VET_ANATOMY)&&this.deleteSubscriptionsTagsByApplication(m.VET_ANATOMY)}deleteSubscriptionsTagsByApplication(e){const t=document.querySelectorAll(`.imaios-anatomy-subscription-tag-${e===m.E_ANATOMY?"eanatomy":"vetanatomy"}`);for(let i=0;i<t.length;i++)t[i].style.setProperty("display","none","important")}hidePlaceholderAndDisplayUserInformation(){imaios.store("is-connected",this.isConnected());const e=document.querySelectorAll(".imaios-placeholder-animated");for(let i=0;i<e.length;i++)e[i].style.setProperty("display","none","important");const t=document.querySelectorAll(".user-information");for(let i=0;i<t.length;i++)t[i].style.setProperty("display","")}displayLoggedOutInformation(){const e=document.querySelectorAll(".imaios-login-logged-out");for(let i=0;i<e.length;i++)e[i].style.setProperty("display",""),e[i].classList.remove("d-none");const t=document.querySelectorAll(".imaios-login-logged-in");for(let i=0;i<t.length;i++)t[i].classList.add("d-none")}getUserAccess(){return g(this,null,function*(){if(this.checkExpire(),l.get(c.IMAIOS_USER_INFORMATION)===null)try{const t=yield this.getUserInformation();typeof t=="object"&&Object.keys(t).length>0&&this.addLoginToStorage(t)}catch(t){return{}}const e=this.getLocalUserData();return e!==null?e.access:{}})}updateAccessViaThirdPartyCookie(){let e=f(p.THIRD_PARTY_PROVIDER);if(e){e=JSON.parse(decodeURIComponent(e));const t=this.getLocalUserData();t!==null&&(t.access[I[e.product.toUpperCase()]]={group_premium:!0},this.addLoginToStorage(t))}}awaitConnection(){return g(this,null,function*(){if(!imaios.get("are-credentials-reliable"))return yield this.awaitableConnection})}}const L=new S;export{L};
//# sourceMappingURL=login-management-service-DTUXGn6C.js.map
